<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Nueva Factura</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-size: 14px;
        }
        .form-label {
            font-size: 14px;
            margin-bottom: 0.2rem;
        }
        .form-control, .form-select {
            font-size: 14px;
            padding: 0.3rem 0.5rem;
        }
        .card-header h4 {
            font-size: 16px;
            margin: 0;
        }
        .card {
            margin-bottom: 1rem;
        }
        .mb-3 {
            margin-bottom: 0.5rem !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <h2 class="h4">Nueva Factura</h2>
        
        <!-- Datos del Emisor y Receptor -->
        <div class="row mb-3">
            <!-- Datos del Emisor -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h4>Datos del Emisor</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">NIT</label>
                                    <input type="text" class="form-control" id="emisorNit" value="04352208241018">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">NRC</label>
                                    <input type="text" class="form-control" id="emisorNrc" value="3477200">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Teléfono</label>
                                    <input type="text" class="form-control" id="emisorTelefono" value="76230990">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label">Nombre</label>
                                    <input type="text" class="form-control" id="emisorNombre" value="Keyjo">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">Actividad Económica</label>
                                    <input type="text" class="form-control" id="emisorActividad" value="VENTA AL POR MAYOR DE COMPUTADORAS, EQUIPO PERIFERICO Y PROGRAMAS INFORMATICOS">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Correo</label>
                                    <input type="email" class="form-control" id="emisorCorreo" value="demo@gmail.com">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label">Dirección</label>
                                    <input type="text" class="form-control" id="emisorDireccion" value="Calle 123, Ciudad, País">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Datos del Receptor -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h4>Datos del Receptor</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Tipo Documento</label>
                                    <select class="form-select" id="receptorTipoDoc">
                                        <option value="37" selected>Consumidor Final</option>
                                        <option value="36">NIT</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Número Documento</label>
                                    <input type="text" class="form-control" id="receptorNumDoc" value="">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Teléfono</label>
                                    <input type="text" class="form-control" id="receptorTelefono" value="78451269">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label">Nombre</label>
                                    <input type="text" class="form-control" id="receptorNombre" value="Josue">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">Dirección</label>
                                    <input type="text" class="form-control" id="receptorDireccion" value="Calle 123, Ciudad, País">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Correo</label>
                                    <input type="email" class="form-control" id="receptorCorreo" value="facturacionelsalvador2025@gmail.com">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Productos -->
        <div class="card mb-3">
            <div class="card-header">
                <h4>Productos</h4>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-2">
                        <input type="text" class="form-control" id="productoCodigo" placeholder="Código">
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="productoDescripcion" placeholder="Descripción">
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control" id="productoCantidad" placeholder="Cantidad">
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control" id="productoPrecio" placeholder="Precio">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="agregarProducto()">
                            <i class="fas fa-plus"></i> Agregar
                        </button>
                    </div>
                </div>

                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Descripción</th>
                            <th>Cantidad</th>
                            <th>Precio Unit.</th>
                            <th>Subtotal</th>
                            <th>IVA</th>
                            <th>Total</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaProductos">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Totales -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 offset-md-6">
                        <table class="table table-sm">
                            <tr>
                                <td>Subtotal:</td>
                                <td class="text-end" id="subtotal">0.00</td>
                            </tr>
                            <tr>
                                <td>IVA:</td>
                                <td class="text-end" id="iva">0.00</td>
                            </tr>
                            <tr>
                                <td><strong>Total:</strong></td>
                                <td class="text-end"><strong id="total">0.00</strong></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-end mb-3">
            <button class="btn btn-success" onclick="procesarFactura()">
                <i class="fas fa-file-invoice"></i> Procesar Factura
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let productos = [];

        // Configuración del emisor (puedes modificar estos valores)
        const configEmisor = {
            nit: "04352208241018",
            claveApi: "Keyjo@2025",
            clave: "Keyjo@Pri9"
        };

        // Función para generar código único (GUID en mayúsculas)
        function generarCodigoUnico() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0,
                    v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            }).toUpperCase();
        }

        // Función para generar número de control
        function generarNumeroControl() {
            const fecha = new Date().toISOString().slice(0,10).replace(/-/g,'');
            const random = Math.floor(Math.random() * 1000000000000000).toString().padStart(15, '0');
            return `DTE-01-${fecha}-${random}`;
        }

        function agregarProducto() {
            const codigo = document.getElementById('productoCodigo').value;
            const descripcion = document.getElementById('productoDescripcion').value;
            const cantidad = parseFloat(document.getElementById('productoCantidad').value);
            const precio = parseFloat(document.getElementById('productoPrecio').value);

            if (!codigo || !descripcion || !cantidad || !precio) {
                alert('Por favor complete todos los campos');
                return;
            }

            const subtotal = cantidad * precio;
            const iva = subtotal * 0.13;
            const total = subtotal + iva;

            const producto = {
                codigo,
                descripcion,
                cantidad,
                precioUni: precio,
                subtotal,
                iva,
                total
            };

            productos.push(producto);
            actualizarTabla();
            actualizarTotales();
            limpiarFormulario();
        }

        function actualizarTabla() {
            const tbody = document.getElementById('tablaProductos');
            tbody.innerHTML = '';

            productos.forEach((producto, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${producto.codigo}</td>
                    <td>${producto.descripcion}</td>
                    <td>${producto.cantidad}</td>
                    <td>${producto.precioUni.toFixed(2)}</td>
                    <td>${producto.subtotal.toFixed(2)}</td>
                    <td>${producto.iva.toFixed(2)}</td>
                    <td>${producto.total.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="eliminarProducto(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function eliminarProducto(index) {
            productos.splice(index, 1);
            actualizarTabla();
            actualizarTotales();
        }

        function actualizarTotales() {
            const subtotal = productos.reduce((sum, p) => sum + p.subtotal, 0);
            const iva = productos.reduce((sum, p) => sum + p.iva, 0);
            const total = subtotal + iva;

            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('iva').textContent = iva.toFixed(2);
            document.getElementById('total').textContent = total.toFixed(2);
        }

        function limpiarFormulario() {
            document.getElementById('productoCodigo').value = '';
            document.getElementById('productoDescripcion').value = '';
            document.getElementById('productoCantidad').value = '';
            document.getElementById('productoPrecio').value = '';
        }

        // Función para convertir número a letras
        function convertirNumeroALetras(numero) {
            const unidades = ['', 'UNO', 'DOS', 'TRES', 'CUATRO', 'CINCO', 'SEIS', 'SIETE', 'OCHO', 'NUEVE'];
            const decenas = ['', 'DIEZ', 'VEINTE', 'TREINTA', 'CUARENTA', 'CINCUENTA', 'SESENTA', 'SETENTA', 'OCHENTA', 'NOVENTA'];
            const especiales = ['DIEZ', 'ONCE', 'DOCE', 'TRECE', 'CATORCE', 'QUINCE', 'DIECISEIS', 'DIECISIETE', 'DIECIOCHO', 'DIECINUEVE'];
            const centenas = ['', 'CIENTO', 'DOSCIENTOS', 'TRESCIENTOS', 'CUATROCIENTOS', 'QUINIENTOS', 'SEISCIENTOS', 'SETECIENTOS', 'OCHOCIENTOS', 'NOVECIENTOS'];

            if (numero === 0) return 'CERO';

            let entero = Math.floor(numero);
            let decimal = Math.round((numero - entero) * 100);

            let resultado = '';

            if (entero > 0) {
                if (entero === 100) {
                    resultado = 'CIEN';
                } else if (entero < 100) {
                    if (entero < 10) {
                        resultado = unidades[entero];
                    } else if (entero < 20) {
                        resultado = especiales[entero - 10];
                    } else {
                        let unidad = entero % 10;
                        let decena = Math.floor(entero / 10);
                        resultado = decenas[decena];
                        if (unidad > 0) {
                            resultado += ' Y ' + unidades[unidad];
                        }
                    }
                } else {
                    let centena = Math.floor(entero / 100);
                    let resto = entero % 100;
                    resultado = centenas[centena];
                    if (resto > 0) {
                        resultado += ' ' + convertirNumeroALetras(resto);
                    }
                }
            }

            resultado += ' DOLARES';
            if (decimal > 0) {
                resultado += ' CON ' + decimal.toString().padStart(2, '0') + '/100';
            }

            return resultado;
        }

        // Función para construir el DTE JSON
        function construirDteJson(codigoGeneracion, numeroControl) {
            // Función auxiliar para redondear a 2 decimales
            function redondear(num) {
                return Math.round(num * 100) / 100;
            }

            // Calcular totales
            const subtotal = redondear(productos.reduce((sum, p) => sum + p.subtotal, 0));
            const iva = redondear(productos.reduce((sum, p) => sum + p.iva, 0));
            const total = redondear(subtotal + iva);

            return {
                identificacion: {
                    version: 1,
                    ambiente: "00",
                    tipoDte: "01",
                    numeroControl: numeroControl,
                    codigoGeneracion: codigoGeneracion,
                    tipoModelo: 1,
                    tipoOperacion: 1,
                    tipoContingencia: null,
                    motivoContin: null,
                    fecEmi: new Date().toISOString().split('T')[0],
                    horEmi: new Date().toTimeString().split(' ')[0],
                    tipoMoneda: "USD"
                },
                documentoRelacionado: null,
                emisor: {
                    nit: document.getElementById('emisorNit').value,
                    nrc: document.getElementById('emisorNrc').value,
                    nombre: document.getElementById('emisorNombre').value,
                    codActividad: "46510",
                    descActividad: document.getElementById('emisorActividad').value,
                    nombreComercial: document.getElementById('emisorNombre').value,
                    tipoEstablecimiento: "02",
                    direccion: {
                        departamento: "04",
                        municipio: "35",
                        complemento: document.getElementById('emisorDireccion').value
                    },
                    telefono: document.getElementById('emisorTelefono').value,
                    codEstableMH: null,
                    codEstable: null,
                    codPuntoVentaMH: null,
                    codPuntoVenta: null,
                    correo: document.getElementById('emisorCorreo').value
                },
                receptor: {
                    tipoDocumento: document.getElementById('receptorTipoDoc').value,
                    numDocumento: document.getElementById('receptorNumDoc').value || "CF",
                    nrc: null,
                    nombre: document.getElementById('receptorNombre').value,
                    codActividad: null,
                    descActividad: null,
                    direccion: {
                        departamento: "04",
                        municipio: "35",
                        complemento: document.getElementById('receptorDireccion').value
                    },
                    telefono: document.getElementById('receptorTelefono').value,
                    correo: document.getElementById('receptorCorreo').value
                },
                ventaTercero: null,
                cuerpoDocumento: productos.map((p, index) => ({
                    numItem: index + 1,
                    tipoItem: 1,
                    numeroDocumento: null,
                    cantidad: p.cantidad,
                    codigo: p.codigo,
                    codTributo: null,
                    uniMedida: 59,
                    descripcion: p.descripcion,
                    precioUni: redondear(p.precioUni),
                    montoDescu: 0,
                    ventaNoSuj: 0,
                    ventaExenta: 0,
                    ventaGravada: redondear(p.subtotal),
                    tributos: null,
                    psv: redondear(p.subtotal),
                    noGravado: 0,
                    ivaItem: redondear(p.subtotal - (p.subtotal / 1.13))
                })),
                resumen: {
                    totalNoSuj: 0,
                    totalExenta: 0,
                    totalGravada: redondear(subtotal),
                    subTotalVentas: redondear(subtotal),
                    descuNoSuj: 0,
                    descuExenta: 0,
                    descuGravada: 0,
                    porcentajeDescuento: 0,
                    totalDescu: 0,
                    tributos: null,
                    subTotal: redondear(subtotal),
                    ivaRete1: 0,
                    reteRenta: 0,
                    montoTotalOperacion: redondear(subtotal),
                    totalNoGravado: 0,
                    totalPagar: redondear(subtotal),
                    totalLetras: convertirNumeroALetras(total),
                    totalIva: redondear(subtotal - (subtotal / 1.13)),
                    saldoFavor: 0,
                    condicionOperacion: 1,
                    pagos: [{
                        codigo: "01",
                        montoPago: redondear(subtotal),
                        referencia: "0000",
                        periodo: null,
                        plazo: null
                    }],
                    numPagoElectronico: "0"
                },
                extension: {
                    nombEntrega: "ENCARGADO 1",
                    docuEntrega: "00000000-0",
                    nombRecibe: null,
                    docuRecibe: null,
                    observaciones: null,
                    placaVehiculo: null
                },
                otrosDocumentos: null,
                apendice: null
            };
        }

        // Función para procesar la factura
        function procesarFactura() {
            const codigoGeneracion = generarCodigoUnico();
            const numeroControl = generarNumeroControl();
            const dteJson = construirDteJson(codigoGeneracion, numeroControl);
            
            // Construir el request unificado con el DteJson como string
            const requestUnificado = {
                Usuario: configEmisor.nit,
                Password: configEmisor.claveApi,
                Ambiente: "00",
                DteJson: JSON.stringify(dteJson),  // Convertir a String
                Nit: configEmisor.nit,
                PasswordPrivado: configEmisor.clave,
                TipoDte: "01",
                CodigoGeneracion: codigoGeneracion,
                NumControl: numeroControl,
                VersionDte: 1
            };

            fetch('https://localhost:7122/api/procesar-dte', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestUnificado)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error al procesar DTE: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                const selloRecepcion = data.selloRecibido || null;
                if (selloRecepcion) {
                    alert('Factura procesada correctamente. Sello de recepción: ' + selloRecepcion);
                    window.location.reload();
                } else {
                    alert('Factura procesada pero no se recibió sello de recepción');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al procesar la factura: ' + error.message);
            });
        }
    </script>
</body>
</html> 